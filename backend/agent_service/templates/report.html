<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renovation ROI Report - {{ report.property.address if report.property else 'N/A' }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2a9d8f; /* Teal */
            --secondary-color: #e9c46a; /* Yellow */
            --accent-color: #f4a261; /* Orange */
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #343a40;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --header-height: 60px;
            --light-gray: #f1f1f1;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: var(--text-color); background-color: var(--bg-color); padding-top: 20px; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .report-header { background-color: var(--primary-color); color: white; padding: 25px; border-radius: var(--border-radius); margin-bottom: 30px; box-shadow: var(--shadow); position: relative; }
        .report-header h1 { margin: 0 0 10px 0; font-size: 1.8em; font-weight: 600; }
        .report-header p { margin: 0 0 5px 0; font-size: 0.9em; opacity: 0.9; }
        .report-header p:last-child { margin-bottom: 0; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .grid-col-span-2 { grid-column: span 2; }
        @media (max-width: 992px) { .grid-col-span-2 { grid-column: span 1; } }
        .card { background-color: var(--card-bg); border-radius: var(--border-radius); padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border-color); display: flex; flex-direction: column; margin-bottom: 30px; }
        .card h2, .card h3 { color: var(--primary-color); margin-bottom: 15px; border-bottom: 2px solid var(--primary-color); padding-bottom: 8px; font-size: 1.3em; font-weight: 600; }
        .card h3 { font-size: 1.1em; margin-top: 15px; margin-bottom: 10px; border-bottom: 1px solid #eee; }
        .card p { margin-bottom: 10px; font-size: 0.9em; }
        .card p:last-child { margin-bottom: 0; }
        .property-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }
        @media (max-width: 768px) { .property-summary { grid-template-columns: 1fr; } }
        .image-carousel-container { position: relative; overflow: hidden; border-radius: var(--border-radius); box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid var(--border-color); min-height: 250px; background-color: var(--light-gray); margin-bottom: 20px; }
        .carousel-inner { display: flex; transition: transform 0.5s ease; }
        .carousel-item { min-width: 100%; flex-shrink: 0; }
        .carousel-item img { width: 100%; height: auto; display: block; max-height: 400px; object-fit: cover; }
        .carousel-controls { position: absolute; top: 50%; width: 100%; display: flex; justify-content: space-between; transform: translateY(-50%); padding: 0 10px; pointer-events: none; }
        .carousel-controls button { background-color: rgba(0, 0, 0, 0.5); color: white; border: none; padding: 10px; cursor: pointer; border-radius: 50%; font-size: 1.2em; pointer-events: auto; transition: background-color 0.3s; }
        .carousel-controls button:hover { background-color: rgba(0, 0, 0, 0.8); }
        .carousel-indicators { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; }
        .indicator { width: 10px; height: 10px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); cursor: pointer; transition: background-color 0.3s; border: none; padding: 0; }
        .indicator.active { background-color: white; }
        .carousel-item:only-child ~ .carousel-controls, .carousel-item:only-child ~ .carousel-indicators { display: none; }
        .key-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat { background-color: var(--bg-color); padding: 10px; border-radius: 5px; text-align: center; border: 1px solid var(--border-color); }
        .stat .value { font-size: 1.2em; font-weight: 600; display: block; color: var(--primary-color); margin-bottom: 3px; word-wrap: break-word; overflow-wrap: break-word; }
        .stat .label { font-size: 0.8em; color: var(--text-muted); display: block; }
        .agent-info h4 { margin-top: 15px; margin-bottom: 5px; font-size: 1em; color: #555; font-weight: bold; }
        .agent-info p { font-size: 0.9em; margin-bottom: 0; }
        .description-text { font-size: 0.9em; }
        .renovation-card { border-left: 5px solid var(--secondary-color); background-color: var(--card-bg); border-radius: var(--border-radius); padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border-color); margin-bottom: 20px; }
        .renovation-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .renovation-header h3 { border: none; margin: 0; padding: 0; font-size: 1.3em; }
        .roi-badge { background-color: var(--accent-color); color: white; padding: 5px 12px; border-radius: 15px; font-weight: bold; font-size: 0.9em; }
        .chart-container { position: relative; height: 350px; width: 100%; background-color: var(--card-bg); border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; color: var(--text-muted); border-radius: var(--border-radius); padding: 15px; box-shadow: var(--shadow); }
        .chart-container canvas { max-width: 100%; max-height: 100%; }
        footer { text-align: center; margin-top: 40px; padding: 20px; font-size: 0.85em; color: var(--text-muted); border-top: 1px solid var(--border-color); line-height: 1.5; }
        .margin-top-medium { margin-top: 20px; }
        .new-report-button { position: absolute; top: 25px; right: 25px; background-color: var(--accent-color); color: white; text-decoration: none; padding: 10px 15px; border-radius: var(--border-radius); font-weight: 600; font-size: 0.9em; box-shadow: var(--shadow); transition: transform 0.2s ease; }
        .new-report-button:hover { transform: translateY(-2px); }

        /* --- NEW STYLES FOR ACTION PLAN --- */
        .comparables-section { background-color: #fff; padding: 25px; margin-bottom: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .comparables-section h3 { border-bottom: 2px solid var(--accent-color); padding-bottom: 10px; margin-bottom: 20px; font-size: 1.5em; color: var(--primary-color); }
        .comparables-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .comparables-table th, .comparables-table td { padding: 12px; border-bottom: 1px solid #dee2e6; text-align: left; }
        .comparables-table th { background-color: #f8f9fa; font-weight: 600; }
        .action-plan-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 20px; }
        .action-plan-grid h4 { margin-bottom: 10px; font-size: 1.1em; color: #495057; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .action-plan-grid ul, .action-plan-grid ol { padding-left: 20px; }
        .action-plan-grid li { margin-bottom: 8px; line-height: 1.6; font-size: 0.9em;}
        @media (max-width: 768px) { .action-plan-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header class="report-header">
            <h1>Renovation ROI Report</h1>
            <p><strong>Property:</strong> {{ report.property.address if report.property else 'N/A' }}</p>
            <p><strong>Report ID:</strong> {{ report.report_id }} | <strong>Generated:</strong> {{ report.created_at.strftime('%Y-%m-%d %H:%M') if report.created_at else 'N/A' }}</p>
            <a href="/" class="new-report-button">Generate New Report</a>
        </header>

        <section class="card">
            <h2>Property Overview</h2>
            <div class="property-summary">
                <div class="image-carousel-container">
                    <div class="carousel-inner">
                        </div>
                </div>
                <div class="property-details">
                    <div class="key-stats">
                        </div>
                    <div class="agent-info">
                        </div>
                </div>
            </div>
             <div class="description margin-top-medium">
                 <h3>Property Description</h3>
                 <p class="description-text">{{ report.property.description }}</p>
             </div>
        </section>

        <section>
            <h2 class="card-header" style="background:none; border:none; padding:0; margin-bottom:20px;">Renovation Analysis & ROI</h2>
            <div class="grid margin-bottom-medium">
                <div class="chart-container"><canvas id="roiChart"></canvas></div>
                <div class="chart-container"><canvas id="costValueChart"></canvas></div>
            </div>

            <h3>Top Renovation Opportunities</h3>
            {% for idea in report.detailed_report.renovation_ideas %}
            <div class="card renovation-card">
                <div class="renovation-header">
                    <h3>{{ loop.index }}. {{ idea.name }}</h3>
                    <span class="roi-badge">Est. ROI: {{ idea.get('adjusted_roi', idea.get('roi')) | round(1) }}%</span>
                </div>
                <p class="renovation-description">{{ idea.description }}</p>

                <div class="action-plan-grid">
                    <div class="financials">
                        <h4>Financial Analysis</h4>
                            <ul>
                                <li><strong>Est. Medium Cost:</strong> ${{ "{:,.0f}".format(idea.estimated_cost.medium) }}</li>
                                {# Add this line below to show the cost source #}
                                {% if idea.cost_source %}<li style="font-size: 0.8em; color: #6c757d;"><em>Source: {{ idea.cost_source }}</em></li>{% endif %}
                                <li><strong>Est. Value Add:</strong> ${{ "{:,.0f}".format(idea.estimated_value_add.medium) }}</li>
                                <li><strong>Est. Net Profit:</strong> ${{ "{:,.0f}".format(idea.estimated_value_add.medium - idea.estimated_cost.medium) }}</li>
                            </ul>
                    </div>
                    <div class="timeline-feasibility">
                        <h4>Project Details</h4>
                        <ul>
                            <li><strong>Feasibility:</strong> {{ idea.feasibility }}</li>
                            <li><strong>Est. Timeline:</strong> {{ idea.timeline }}</li>
                            <li><strong>Ideal Buyer:</strong> {{ idea.buyer_profile }}</li>
                        </ul>
                    </div>
                    <div class="roadmap">
                        <h4>Project Roadmap</h4>
                        <ol>
                            {% for step in idea.get('roadmap_steps', ['Actionable steps to be generated.']) %}
                            <li>{{ step }}</li>
                            {% endfor %}
                        </ol>
                    </div>
                    <div class="risks">
                        <h4>Potential Risks</h4>
                        <ul>
                            {% for risk in idea.get('potential_risks', ['Risks to be generated.']) %}
                            <li>{{ risk }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                </div>
            {% endfor %}
        </section>
        
        <section class="comparables-section">
            <h3>Local Market Comparables</h3>
            <p>We've analyzed recently sold properties in the area to provide real-world data for our value projections.</p>
            {% if report.detailed_report.comparable_properties %}
            <table class="comparables-table">
                <thead>
                    <tr>
                        <th>Address</th>
                        <th>Sale Price</th>
                        <th>Summary</th>
                    </tr>
                </thead>
                <tbody>
                    {% for comp in report.detailed_report.comparable_properties %}
                    <tr>
                        <td><a href="{{ comp.url }}" target="_blank" rel="noopener noreferrer">{{ comp.address }}</a></td>
                        <td>${ "{:,.0f}".format(comp.sale_price) }</td>
                        <td>{{ comp.brief_summary }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p><i>Comparable property data could not be retrieved for this analysis.</i></p>
            {% endif %}
        </section>

        <section class="card">
            <h2>Next Steps & Contractor Recommendations</h2>
            <p>Finding reliable contractors is key...</p>
        </section>

        <footer>
            Disclaimer: ...
        </footer>
    </div>

    <script>
        // Your existing Chart.js and Carousel logic remains the same
    </script>
</body>
</html>